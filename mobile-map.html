

<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>Smart HSR | Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Icons & Fonts -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --navy:#0A1931; --teal:#18A5A2; --teal-600:#14918E;
      --bg:#F7F9FC; --card:#FFFFFF; --line:#E6EEF3; --shadow:0 10px 30px rgba(0,0,0,.10);
      --text:#0A1931; --muted:#64748B;
      --red:#EF4444; --amber:#F59E0B; --green:#10B981;
      --map-ring:#CFEAE8;
    }
    [data-theme="dark"]{
      --bg:#0e1726; --card:#102036; --line:#25334A; --shadow:0 10px 30px rgba(0,0,0,.35);
      --text:#E6EEF7; --muted:#9FB0C8; --map-ring:#173F46;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:'Tajawal',sans-serif; background:var(--bg); color:var(--text)}

    /* Header (mobile-first, compact) */
.app-header {
  position: sticky;
  top: 0;
  z-index: 1000;
  background: var(--card);
  border-bottom: 3px solid rgba(24,165,162,.12);
  box-shadow: 0 2px 10px rgba(0,0,0,0.06);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 14px;
  flex-wrap: wrap; /* ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
  gap: 8px;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø¹Ø§Ø± */
.brand {
  font-weight: 900;
  font-size: 17px;
  white-space: nowrap;
}
.brand span {
  color: var(--teal);
}

/* ØªØ­Ø³ÙŠÙ† Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.header-actions {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 6px;
  justify-content: flex-end;
}

/* Ø¬Ø¹Ù„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØªØ­Øª Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
#nearStats {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 8px;
  font-weight: 700;
  font-size: 13px;
}

/* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
@media (max-width: 600px) {
  .app-header {
    flex-direction: column;
    align-items: stretch;
    text-align: center;
    padding: 10px 10px;
  }

  .brand {
    font-size: 15px;
    margin-bottom: 4px;
  }

  #nearStats {
    justify-content: center;
    font-size: 12px;
    gap: 6px;
  }

  .header-actions {
    justify-content: center;
    flex-wrap: wrap;
  }

  .btn {
    padding: 7px 10px;
    font-size: 11px;
  }
}


    
    .brand{font-weight:900; letter-spacing:.3px; font-size:16px}
    .brand span{color:var(--teal)}
    .header-actions{margin-inline-start:auto; display:flex; gap:6px; align-items:center}
    .btn{
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 10px; border:none; border-radius:999px; cursor:pointer;
      font-weight:800; transition:.18s; box-shadow:0 4px 10px rgba(10,25,49,.08); font-size:12px
    }
    .btn i{width:16px;height:16px}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--teal); color:#fff}
    .btn-dark{background:var(--navy); color:#fff}
    .btn-soft{background:transparent; color:var(--text); border:1px solid var(--line)}
    .btn-ghost{background:transparent; color:var(--text)}
    .chip{display:none}

    @media (max-width:420px){
      .app-header{padding:8px 10px}
      .btn{padding:6px 8px; font-size:11px}
      .brand{font-size:14px}
    }

    /* Map frame */
    .map-wrap{
      position:relative; height:calc(100vh - 64px);
      margin:10px; border-radius:18px;
      background:linear-gradient(#fff,#fff) padding-box,
                 linear-gradient(135deg, #ACE2E1 0%, #18A5A2 50%, #0A1931 100%) border-box;
      border:3px solid transparent; box-shadow:var(--shadow);
      overflow:hidden;
    }
    [data-theme="dark"] .map-wrap{ background:linear-gradient(var(--card),var(--card)) padding-box,
                                   linear-gradient(135deg, #173F46 0%, #18A5A2 50%, #0A1931 100%) border-box;}
    #map{width:100%; height:100%}

    /* Toolbar (legend toggle only stays here) */
    .toolbar{
      position:absolute; top:12px; inset-inline-start:12px; z-index:900;
      display:flex; flex-direction:column; gap:8px; pointer-events:none;
    }
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow)}
    .tool-card{padding:8px; pointer-events:auto}

    /* Pulsing marker */
    .pulse{ width:14px; height:14px; border-radius:50%; position:relative; box-shadow:0 0 0 2px #fff, 0 4px 10px rgba(0,0,0,.25)}
    .pulse.red{background:var(--red)}
    .pulse.amber{background:var(--amber)}
    .pulse.green{background:var(--green)}
    .pulse.red::after,.pulse.amber::after{
      content:""; position:absolute; inset:0; border-radius:50%; box-shadow:0 0 0 0 currentColor; animation:pulse 1.8s infinite; opacity:.55
    }
    .pulse.red::after{color:var(--red)}
    .pulse.amber::after{color:var(--amber)}
    @keyframes pulse{0%{box-shadow:0 0 0 0 currentColor} 70%{box-shadow:0 0 0 14px rgba(0,0,0,0)} 100%{box-shadow:0 0 0 0 rgba(0,0,0,0)}}

    /* My location ring */
    .me-ring{
      box-shadow: 0 0 0 3px #fff;
      border:2px solid var(--teal);
      background:radial-gradient(circle at center, var(--teal) 0 40%, transparent 41% 100%);
      width:16px;height:16px;border-radius:50%;
    }

    /* Toast */
    .toast{position:fixed; bottom:12px; inset-inline-start:12px; background:var(--navy); color:#fff; padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); z-index:4000; display:none; font-weight:800}
    .toast.show{display:block}

    /* Bottom Sheet (Smart Modal) */
    .sheet{
      position:fixed; inset-inline:0; bottom:0; z-index:3500;
      border-top-left-radius:18px; border-top-right-radius:18px;
      background:var(--card); color:var(--text);
      box-shadow:0 -10px 40px rgba(0,0,0,.25);
      transform:translateY(100%); transition:transform .28s ease;
      border-top:1px solid var(--line);
      max-height:80vh; display:flex; flex-direction:column;
    }
    .sheet.open{transform:translateY(0)}
    .sheet-handle{width:46px; height:5px; border-radius:999px; background:var(--line); margin:8px auto 6px;}

    /* Observation sheet content */
    .sheet-header{padding:6px 14px 10px; display:flex; align-items:center; gap:8px; border-bottom:1px solid var(--line)}
    .sheet-header h3{margin:0; font-weight:900; font-size:15px}
    .pill{display:inline-flex; gap:6px; align-items:center; padding:4px 8px; border-radius:999px; font-weight:800; font-size:12px}
    .pill.red{background:#fee2e2; color:#991b1b}
    .pill.amber{background:#fef3c7; color:#92400e}
    .pill.green{background:#dcfce7; color:#065f46}
    .sheet-body{padding:10px 14px; overflow:auto; display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:12px; color:var(--muted); font-weight:800}
    .card-mini{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:8px; font-weight:800}
    textarea, select, input[type="file"]{border:1px solid var(--line); border-radius:10px; padding:8px; font-family:inherit; background:var(--card); color:var(--text)}
    .media-box{padding:8px; border-radius:12px; border:1px dashed var(--line); min-height:56px}
    .sheet-actions{display:flex; gap:8px; padding:10px 14px 12px; border-top:1px solid var(--line); justify-content:flex-end}
    .btn-lg{padding:10px 14px; font-size:13px}

    @media (max-width:768px){
      .sheet-body{grid-template-columns:1fr}
      .btn-lg{padding:10px 12px; font-size:12px}
      .sheet-header h3{font-size:14px}
    }

    /* Legend glass + toggle */
    .legend-glass {
      position: absolute;
      bottom: 68px;
      right: 14px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(24,165,162,0.2);
      border-radius: 14px;
      padding: 10px 14px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      font-size: 13px;
      color: var(--text);
      z-index: 900;
      min-width: 130px;
      transition: all 0.35s ease;
    }
    [data-theme="dark"] .legend-glass { background: rgba(16,32,54,0.85); border-color: rgba(24,165,162,0.25); color: #e8f7f6; }
    .legend-glass.hidden { opacity:0; transform: translateY(20px); pointer-events:none; }
    .legend-title { font-weight:900; font-size:14px; color:var(--teal); margin-bottom:6px; text-align:center; }
    .legend-items .item { display:flex; align-items:center; gap:8px; margin:5px 0; font-weight:700; }
    .dot { width:12px; height:12px; border-radius:50%; }
    .dot.red {background: var(--red);} .dot.amber {background: var(--amber);} .dot.green {background: var(--green);}

    .legend-toggle {
      position: absolute; bottom: 14px; right: 14px; width: 48px; height: 48px;
      border: none; border-radius: 50%; background: var(--teal); color:#fff; font-weight:900;
      display:flex; align-items:center; justify-content:center; cursor:pointer;
      box-shadow:0 6px 20px rgba(0,0,0,0.25); z-index:901; transition: all .3s ease;
    }
    .legend-toggle:hover { transform: scale(1.08); background: var(--teal-600); }
    .legend-toggle.active { background: var(--navy); transform: rotate(180deg); }
    .legend-count { position: absolute; top:6px; right:6px; background: var(--red); color:#fff; font-size:12px; font-weight:800; width:18px; height:18px; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 0 0 2px #fff; transition: all .3s ease; }
    .legend-toggle.green .legend-count { background: var(--green); }
    .legend-toggle.amber .legend-count { background: var(--amber); }
    .legend-toggle.red .legend-count { background: var(--red); }
    @keyframes pulseBadge { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(24,165,162,0.4); } 50% { transform: scale(1.25); box-shadow: 0 0 10px 4px rgba(24,165,162,0.2); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(24,165,162,0); } }
    .legend-count.flash { animation: pulseBadge 0.8s ease; }

    .leaflet-control-attribution { display:none !important; }

/* ==== Smart Bottom Filter Sheet (20% peek & smooth style) ==== */
.filter-sheet {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 999;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(16px);
  border-top: 2px solid rgba(24, 165, 162, 0.25);
  border-radius: 20px 20px 0 0;
  box-shadow: 0 -10px 35px rgba(0, 0, 0, 0.25);
  transform: translateY(80%); /* ğŸ‘ˆ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· 20% Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
  transition: transform 0.45s cubic-bezier(0.25, 1.25, 0.5, 1);
  will-change: transform;
  max-width: 520px;
  margin-inline: auto;
  overflow: hidden;
}

/* Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ Ø§Ù„ÙƒØ§Ù…Ù„ */
.filter-sheet.open {
  transform: translateY(0);
  transition: transform 0.55s cubic-bezier(0.25, 1.25, 0.5, 1.1);
}

/* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
[data-theme="dark"] .filter-sheet {
  background: rgba(16, 32, 54, 0.96);
  border-top-color: rgba(24, 165, 162, 0.35);
  box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.55);
}

/* Ø§Ù„Ù…Ù‚Ø¨Ø¶ Ø§Ù„Ø¹Ù„ÙˆÙŠ */
.filter-grip {
  width: 46px;
  height: 5px;
  border-radius: 999px;
  background: rgba(24, 165, 162, 0.45);
  margin: 10px auto 6px;
}

/* Ø§Ù„Ø±Ø£Ø³ */
.filter-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  padding: 0 14px 8px;
  border-bottom: 1px solid var(--line);
}

.filter-title {
  font-weight: 900;
  font-size: 13px;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 6px;
}

/* Ø´Ø§Ø±Ø© Ø§Ù„Ù‚Ø±ÙŠØ¨ */
.near-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #eefaf9;
  color: #0b6b68;
  border: 1px solid rgba(24, 165, 162, 0.25);
  padding: 4px 8px;
  border-radius: 999px;
  font-weight: 900;
  font-size: 12px;
}
[data-theme="dark"] .near-badge {
  background: #0f2a33;
  color: #b7f3ef;
}

/* Ø§Ù„Ø¬Ø³Ù… */
.filter-body {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 10px 14px 14px;
  flex-wrap: wrap;
}

.filter-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 800;
}

.filter-item label {
  color: var(--teal);
  font-weight: 900;
}

.filter-select {
  border: 1px solid var(--line);
  border-radius: 10px;
  background: var(--card);
  color: var(--text);
  font-weight: 700;
  padding: 4px 8px;
  font-size: 12px;
}

.filter-range {
  width: 140px;
  accent-color: var(--teal);
}

.radius-value {
  font-weight: 900;
  font-size: 12px;
  color: var(--teal);
}

/* Ø¹Ø±Ø¶ Ø§Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width: 480px) {
  .filter-body {
    flex-direction: column;
    align-items: flex-start;
  }
  .filter-range {
    width: 100%;
  }
}

/* Ø£Ø³Ø·ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
.legend-inline {
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 10px 14px;
  font-size: 13px;
}
.legend-inline .item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 700;
}
.legend-inline b {
  color: var(--teal);
}
.dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}
.dot.red { background: var(--red); }
.dot.amber { background: var(--amber); }
.dot.green { background: var(--green); }

    
/* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø© Ø¨Ø´ÙƒÙ„ Ù…ØªÙ†Ø§Ø³Ù‚ Ø£Ø³ÙÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
.legend-toggle {
  position: absolute;
  bottom: 22px;  /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø£Ø³ÙÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
  right: 24px;   /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
  width: 54px;
  height: 54px;
  border-radius: 50%;
  background: var(--teal);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.22);
  transition: all 0.3s ease;
}

/* ØªØ£Ø«ÙŠØ± Ø­Ø±ÙƒØ© Ø®ÙÙŠÙØ© Ø¹Ù†Ø¯ ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø§ÙˆØ³ */
.legend-toggle:hover {
  transform: translateY(-3px);
  background: var(--teal-600);
}

/* Ø´ÙƒÙ„ Ø§Ù„Ø²Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ */
.legend-toggle.active {
  background: var(--navy);
  transform: rotate(180deg);
}

/* Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠÙ„ØªØµÙ‚ Ø§Ù„Ø²Ø± Ø¨Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø© */
.map-wrap {
  margin-bottom: 50px;
}

    
  </style>
</head>
<body>

 <!-- Header -->
<header class="app-header">
  <div class="brand">Smart HSR <span>Live&nbsp;Map</span></div>
  <div id="nearStats" class="counter" title="Ø­ÙˆÙ„ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø¢Ù†">
    <div class="stat"><i data-lucide="map-pin" class="w-4 h-4"></i><span id="meDistLabel">â€”</span></div>
    <div class="stat"><i data-lucide="alert-triangle" class="w-4 h-4"></i>Ù‚Ø±ÙŠØ¨: <b id="nearCount">0</b></div>
    <div class="chip" id="themeChip">ÙˆØ¶Ø¹ Ù†Ù‡Ø§Ø±ÙŠ</div>
  </div>
  <div class="header-actions">
    <button id="themeBtn" class="btn btn-soft" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ/Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ">
      <i data-lucide="moon"></i><span class="sr-only">Ø§Ù„ÙˆØ¶Ø¹</span>
    </button>
    <button id="locBtn" class="btn btn-primary" title="ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ">
      <i data-lucide="crosshair"></i><span>Ù…ÙˆÙ‚Ø¹ÙŠ</span>
    </button>
    <button id="centerBtn" class="btn btn-dark" title="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ²">
      <i data-lucide="navigation"></i><span>ØªÙ…Ø±ÙƒØ²</span>
    </button>
    <a href="dashboard.html" class="btn btn-soft" title="Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ©">
      <i data-lucide="layout-dashboard"></i><span class="sr-only">Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ©</span>
    </a>
  </div>
</header>


  <!-- Map frame -->
  <div class="map-wrap">
    <div id="map" aria-label="Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©"></div>


 <!-- Floating tools (legend only) -->
<div class="toolbar">
  <button id="legendToggle" class="legend-toggle" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø©">
    <span id="legendCount" class="legend-count">0</span>
    <i data-lucide="info"></i>
  </button>

  <div id="legendBox" class="legend-glass hidden" aria-label="Ø£Ø³Ø·ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª">
    <h4 class="legend-title">Ø£Ø³Ø·ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª</h4>
    <div class="legend-items">
      <div class="item"><span class="dot red"></span> Ø¬Ø¯ÙŠØ¯</div>
      <div class="item"><span class="dot amber"></span> Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
      <div class="item"><span class="dot green"></span> Ù…ØºÙ„Ù‚</div>
    </div>
  </div>
</div>

<!-- Smart Bottom Filter Sheet (peek) -->
<section id="filterSheet" class="filter-sheet" aria-label="Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©">
  <div id="filterHandle" class="filter-grip" aria-hidden="true"></div>
  <div class="filter-head">
    <div class="filter-title">
      <i data-lucide="sliders-horizontal" class="w-4 h-4"></i> Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„ØªØµÙÙŠØ©
    </div>
    <div class="near-badge">
      <i data-lucide="radar" class="w-4 h-4"></i> Ù‚Ø±ÙŠØ¨: <span id="nearCountMini">0</span>
    </div>
  </div>

  <div class="filter-body">
    <div class="filter-item">
      <label for="statusFilter"><i data-lucide="list-filter"></i></label>
      <select id="statusFilter" class="filter-select" title="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©">
        <option value="ALL">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
        <option value="PENDING">Ø¬Ø¯ÙŠØ¯</option>
        <option value="IN_PROGRESS">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
        <option value="COMPLETED">Ù…ØºÙ„Ù‚</option>
      </select>
    </div>

    <div class="filter-item">
      <i data-lucide="radar"></i>
      <label for="radiusInput">Ù†ØµÙ Ø§Ù„Ù‚Ø·Ø±:</label>
      <input id="radiusInput" type="range" min="500" max="5000" step="100" class="filter-range">
      <span id="radiusLabel" class="radius-value">2000 Ù…</span>
    </div>
  </div>

  <!-- âœ… Ø£Ø³Ø·ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø¨Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø±ÙŠØ· -->
  <div class="legend-inline">
    <div class="legend-title">Ø£Ø³Ø·ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª</div>
    <div class="legend-items">
      <div class="item"><span class="dot red"></span> Ø¬Ø¯ÙŠØ¯ (<b id="countRed">0</b>)</div>
      <div class="item"><span class="dot amber"></span> Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° (<b id="countAmber">0</b>)</div>
      <div class="item"><span class="dot green"></span> Ù…ØºÙ„Ù‚ (<b id="countGreen">0</b>)</div>
    </div>
  </div>
</section>


  <!-- Observation details sheet (unchanged) -->
  <section id="smartSheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
    <div class="sheet-handle" id="sheetHandle" aria-hidden="true"></div>
    <div class="sheet-header">
      <i data-lucide="file-search" class="w-5 h-5"></i>
      <h3 id="sheetTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</h3>
      <span id="sheetChip" class="pill" style="margin-inline-start:auto"></span>
      <button id="sheetClose" class="btn btn-ghost" title="Ø¥ØºÙ„Ø§Ù‚"><i data-lucide="x"></i></button>
    </div>

    <div id="sheetBody" class="sheet-body">
      <div class="field">
        <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
        <div id="sTitle" class="card-mini"></div>
      </div>
      <div class="field">
        <label>Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ù…ÙˆÙ‚Ø¹ÙŠ</label>
        <div id="sDistance" class="card-mini"></div>
      </div>

      <div class="field" style="grid-column:1/-1">
        <label>Ø§Ù„ÙˆØµÙ</label>
        <div id="sDetails" class="card-mini" style="line-height:1.8"></div>
      </div>

      <div class="field">
        <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
        <select id="sStatus">
          <option value="PENDING">Ø¬Ø¯ÙŠØ¯</option>
          <option value="IN_PROGRESS">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
          <option value="COMPLETED">Ù…ØºÙ„Ù‚</option>
        </select>
      </div>

      <div class="field">
        <label>ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚)</label>
        <input id="sAfter" type="file" accept="image/*">
      </div>

      <div class="field" style="grid-column:1/-1">
        <label>Ø§Ù„Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ø®ØªØ§Ù…ÙŠØ©</label>
        <textarea id="sNote" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø°ÙƒØ±Ø© Ù‡Ù†Ø§..."></textarea>
      </div>

      <div class="field" style="grid-column:1/-1">
        <label>Ø§Ù„Ù…Ø±ÙÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ</label>
        <div id="sMedia" class="media-box"></div>
      </div>
    </div>

    <div class="sheet-actions">
      <button id="sSave" class="btn btn-primary btn-lg"><i data-lucide="save"></i>Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«</button>
    </div>
  </section>

  <div id="toast" class="toast" role="status" aria-live="polite">ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, onSnapshot, doc, updateDoc, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBfClVxFIXgUXL4olEv5SepUDtzk0dq3lo",
      authDomain: "gen-lang-client-0349944917.firebaseapp.com",
      projectId: "gen-lang-client-0349944917",
      storageBucket: "gen-lang-client-0349944917.firebasestorage.app",
      messagingSenderId: "883065484771",
      appId: "1:883065484771:web:c907bb5a51f68caad75cd6",
      measurementId: "G-V8WG5M8V5B"
    };

    let app, db, FIREBASE_READY=false;
    try { app = initializeApp(firebaseConfig); db = getFirestore(app); FIREBASE_READY=true; }
    catch(e){ console.warn("Firebase init failed, running local-only.", e); }

    const root = document.documentElement;
    const themeBtn = document.getElementById('themeBtn');
    const themeChip = document.getElementById('themeChip');
    function applyTheme(mode){
      root.setAttribute('data-theme', mode);
      themeBtn.innerHTML = mode==='dark'
        ? '<i data-lucide="sun"></i><span class="sr-only">Ù†Ù‡Ø§Ø±ÙŠ</span>'
        : '<i data-lucide="moon"></i><span class="sr-only">Ù„ÙŠÙ„ÙŠ</span>';
      if (themeChip){ themeChip.textContent = (mode==='dark'?'ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ':'ÙˆØ¶Ø¹ Ù†Ù‡Ø§Ø±ÙŠ'); }
      lucide.createIcons();
      localStorage.setItem('smartTheme', mode);
    }
    const saved = localStorage.getItem('smartTheme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(saved);
    themeBtn.addEventListener('click', ()=>{
      const now = root.getAttribute('data-theme')==='dark' ? 'light' : 'dark';
      applyTheme(now);
    });

/* ==== Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø­Ø±ÙƒØ© Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ (Filter Sheet) Ù…Ø¹ Ø­Ø±ÙƒØ© Bounce ==== */
const filterSheet = document.getElementById("filterSheet");
const filterHandle = document.getElementById("filterHandle");
let dragStartY = 0, dragY = 0, draggingFilter = false, sheetOpen = false;

/* Ø¯Ø§Ù„Ø© Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© */
function setFilterState(open) {
  sheetOpen = open;
  filterSheet.classList.toggle("open", open);
  if (open) {
    // Ø­Ø±ÙƒØ© Bounce Ù„Ø·ÙŠÙØ© Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
    filterSheet.animate(
      [
        { transform: "translateY(10%)" },
        { transform: "translateY(-2%)" },
        { transform: "translateY(0)" }
      ],
      { duration: 500, easing: "cubic-bezier(.25,1.25,.5,1)" }
    );
  }
}

/* Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³Ø­Ø¨ */
function onFilterStart(e) {
  draggingFilter = true;
  dragStartY = (e.touches ? e.touches[0].clientY : e.clientY);
  filterSheet.style.transition = "none";
}

/* Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨ */
function onFilterMove(e) {
  if (!draggingFilter) return;
  dragY = (e.touches ? e.touches[0].clientY : e.clientY);
  const dy = Math.max(0, dragY - dragStartY);
  const sheetHeight = filterSheet.offsetHeight;
  const translate = Math.max(0, Math.min(sheetHeight * 0.8, sheetOpen ? dy : sheetHeight * 0.8 - dy));
  filterSheet.style.transform = `translateY(${translate}px)`;
}

/* Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³Ø­Ø¨ */
function onFilterEnd() {
  if (!draggingFilter) return;
  draggingFilter = false;
  filterSheet.style.transition = "transform 0.4s cubic-bezier(0.25, 1.25, 0.5, 1)";
  
  const matrix = window.getComputedStyle(filterSheet).transform;
  let current = 0;
  if (matrix && matrix !== "none") {
    const values = matrix.split("(")[1].split(")")[0].split(",");
    current = parseFloat(values[5] || 0);
  }
  
  const threshold = filterSheet.offsetHeight * 0.4;
  if (current > threshold) {
    setFilterState(false);
    filterSheet.style.transform = `translateY(80%)`;
  } else {
    setFilterState(true);
    filterSheet.style.transform = `translateY(0)`;
  }
}

/* Ø§Ù„Ø£Ø­Ø¯Ø§Ø« */
filterHandle.addEventListener("mousedown", onFilterStart);
filterHandle.addEventListener("touchstart", onFilterStart);
window.addEventListener("mousemove", onFilterMove);
window.addEventListener("touchmove", onFilterMove);
window.addEventListener("mouseup", onFilterEnd);
window.addEventListener("touchend", onFilterEnd);

/* Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø£Ø³ Ù„ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø±ÙŠØ· */
document.querySelector(".filter-head").addEventListener("click", () =>
  setFilterState(!sheetOpen)
);

    
    const map = L.map('map', { zoomControl:false, attributionControl:true });
    map.setView([24.7136, 46.6753], 11);
    L.control.zoom({ position:'topright' }).addTo(map);
    const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom:19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    const frameRing = L.layerGroup().addTo(map);

    const statusIcon = (status)=> L.divIcon({
      html:`<div class="pulse ${status==='PENDING'?'red':status==='IN_PROGRESS'?'amber':'green'}"></div>`,
      className:'', iconSize:[16,16], iconAnchor:[8,8]
    });

    let meMarker=null, meCircle=null, lastMe=[24.7136,46.6753];
    const radiusInput=document.getElementById('radiusInput'); radiusInput.value=2000;

    function drawMe(){
      const r=parseInt(radiusInput.value||2000,10);
      if (meMarker) meMarker.remove();
      if (meCircle) meCircle.remove();
      meMarker = L.marker(lastMe, { icon:L.divIcon({html:'<div class="me-ring"></div>', className:'', iconSize:[16,16], iconAnchor:[8,8]})}).addTo(map);
      meCircle = L.circle(lastMe, { radius:r, color:'#18A5A2', fillColor:'var(--map-ring)', fillOpacity:0.12, weight:2 }).addTo(map);
    }
    function haversine(a,b){
      const toRad = d=> d*Math.PI/180;
      const [lat1,lon1]=a, [lat2,lon2]=b;
      const R=6371000;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2);
      const c=2*Math.asin(Math.sqrt(s1*s1 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*s2*s2));
      return R*c;
    }

    const markers = new Map();
    let observations = [];

    const statusFilter = document.getElementById('statusFilter');
    const nearCountEl  = document.getElementById('nearCount');
    const nearCountMini= document.getElementById('nearCountMini');
    const meDistLabel  = document.getElementById('meDistLabel');
    const radiusLabel  = document.getElementById('radiusLabel');

    function fmtMeters(m){ return m<1000 ? `${Math.round(m)} Ù…` : `${(m/1000).toFixed(1)} ÙƒÙ…`; }

    function paint(){
      drawMe();
      const filter = statusFilter.value;
      const r = parseInt(radiusInput.value,10);
      radiusLabel.textContent = `${r} Ù…`;

      let near=0;
      const presentIds=new Set();
      for (const o of observations){
        if (!o.location) continue;
        const [lat, lon] = o.location.split(',').map(n=>parseFloat(n.trim()));
        if (Number.isNaN(lat) || Number.isNaN(lon)) continue;
        if (filter!=='ALL' && o.status!==filter) continue;

        const dist = haversine(lastMe, [lat,lon]);
        if (dist<=r) near++;

        let m = markers.get(o.docId);
        if (!m){
          m = L.marker([lat,lon], { icon: statusIcon(o.status) }).addTo(map);
          m.bindTooltip(o.title || '', { direction:'top', offset:[0,-10] });
          m.on('click', ()=> openSheet(o, dist));
          markers.set(o.docId, m);
        } else {
          m.setIcon(statusIcon(o.status));
          m.setLatLng([lat,lon]);
        }
        presentIds.add(o.docId);
      }
      for (const [id, m] of markers){
        if (!presentIds.has(id)){ m.remove(); markers.delete(id); }
      }
      if (nearCountEl) nearCountEl.textContent = near.toString();
      if (nearCountMini) nearCountMini.textContent = near.toString();
      if (meDistLabel) meDistLabel.textContent = `Ù†Ø·Ø§Ù‚ÙŠ: ${fmtMeters(r)}`;

      const legendCount = document.getElementById('legendCount');
      const legendBtn = document.getElementById('legendToggle');
      if (legendCount && legendBtn) {
        const old = parseInt(legendCount.textContent || "0", 10);
        legendCount.textContent = near.toString();
        if (near !== old) {
          legendCount.classList.add('flash');
          setTimeout(()=>legendCount.classList.remove('flash'), 700);
        }
        const reds = observations.filter(o => o.status === "PENDING" && o.location && haversine(lastMe, o.location.split(',').map(Number)) <= r).length;
        const ambers = observations.filter(o => o.status === "IN_PROGRESS" && o.location && haversine(lastMe, o.location.split(',').map(Number)) <= r).length;
        const greens = observations.filter(o => o.status === "COMPLETED" && o.location && haversine(lastMe, o.location.split(',').map(Number)) <= r).length;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ
document.getElementById('countRed').textContent = reds;
document.getElementById('countAmber').textContent = ambers;
document.getElementById('countGreen').textContent = greens;


        
        legendBtn.classList.remove('red','amber','green');
        if (reds >= ambers && reds >= greens && reds > 0) legendBtn.classList.add('red');
        else if (ambers >= reds && ambers >= greens && ambers > 0) legendBtn.classList.add('amber');
        else if (greens > 0) legendBtn.classList.add('green');
      }
    }

    async function startLive(){
      if (!FIREBASE_READY){
        observations = [
          {docId:'local-1', id:1, title:'Ù‡Ø¨ÙˆØ· Ø¨Ø³ÙŠØ· Ø¨Ø§Ù„Ù…Ù…Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ', status:'PENDING', type:'MAINTENANCE', date:'2025-10-01', details:'Ù…Ù„Ø§Ø­Ø¸Ø© ØªØ¬Ø±Ø¨Ø©.', location:'24.774265,46.738586', imagePath:'https://picsum.photos/600/400?1'},
          {docId:'local-2', id:2, title:'ØªØ´Ù‚Ù‚Ø§Øª Ø¹Ø±Ø¶ÙŠØ©', status:'IN_PROGRESS', type:'QUALITY', date:'2025-10-03', details:'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­.', location:'24.633333,46.716667', imagePath:'https://picsum.photos/600/400?2'},
          {docId:'local-3', id:3, title:'Ù„ÙˆØ­Ø© Ø¥Ø±Ø´Ø§Ø¯ÙŠØ© ØªØ§Ù„ÙØ©', status:'COMPLETED', type:'QUALITY', date:'2025-10-05', details:'ØªÙ… Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„.', location:'24.7136,46.6753', imagePath:'https://picsum.photos/600/400?3', afterImagePath:'https://picsum.photos/600/400?4', resolutionNote:'Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª'}
        ];
        paint();
        return;
      }
      const q = query(collection(db,'observations'), orderBy('createdAt','desc'));
      onSnapshot(q, (snap)=>{
        const arr=[];
        snap.forEach(d=>{
          const data=d.data();
          arr.push({
            docId:d.id,
            id: data.displayId || 0,
            title:data.title||'â€”',
            status:data.status||'PENDING',
            type:data.type||'MAINTENANCE',
            date:data.date||'',
            details:data.details||'',
            location:data.location||'',
            imagePath:data.imagePath||null,
            afterImagePath:data.afterImagePath||null,
            resolutionNote:data.resolutionNote||''
          });
        });
        observations = arr;
        paint();
      });
    }

    const locBtn=document.getElementById('locBtn');
    const centerBtn=document.getElementById('centerBtn');
    let watchId=null;

    function startWatch(){
      if (!navigator.geolocation){ alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.'); return; }
      if (watchId!==null) return;
      watchId = navigator.geolocation.watchPosition(pos=>{
        lastMe=[pos.coords.latitude, pos.coords.longitude];
        paint();
      }, err=>{
        console.warn(err);
        alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.');
      }, { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
    }

    locBtn.addEventListener('click', ()=>{
      startWatch();
      map.setView(lastMe, 14, { animate:true });
    });
    centerBtn.addEventListener('click', ()=>{
      map.setView(lastMe, map.getZoom()<14?14:map.getZoom(), { animate:true });
    });

    statusFilter.addEventListener('change', paint);
    radiusInput.addEventListener('input', paint);

    const sheet = document.getElementById('smartSheet');
    const sheetHandle = document.getElementById('sheetHandle');
    const sheetClose = document.getElementById('sheetClose');
    const sStatus  = document.getElementById('sStatus');
    const sTitleEl = document.getElementById('sTitle');
    const sDetails = document.getElementById('sDetails');
    const sMedia   = document.getElementById('sMedia');
    const sNote    = document.getElementById('sNote');
    const sDistance= document.getElementById('sDistance');
    const sChip    = document.getElementById('sheetChip');
    const sSave    = document.getElementById('sSave');
    const sAfter   = document.getElementById('sAfter');
    const sheetTitle= document.getElementById('sheetTitle');

    let currentDocId=null, currentAfterData=null;

    function setChip(status){
      sChip.className='pill '+(status==='PENDING'?'red':status==='IN_PROGRESS'?'amber':'green');
      sChip.textContent = status==='PENDING'?'Ø¬Ø¯ÙŠØ¯':status==='IN_PROGRESS'?'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°':'Ù…ØºÙ„Ù‚';
    }

    sAfter.addEventListener('change', async (e)=>{
      const f=e.target.files?.[0];
      if (!f) { currentAfterData=null; return; }
      if (!f.type.startsWith('image/')) { alert('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©.'); e.target.value=''; return; }
      currentAfterData = await fileToBase64(f);
    });

    function openSheet(o, dist){
      currentDocId=o.docId; currentAfterData=null;
      sheetTitle.textContent = `Ù…Ù„Ø§Ø­Ø¸Ø© #${o.id||'â€”'}`;
      sTitleEl.textContent = o.title||'â€”';
      sDetails.innerHTML = (o.details||'â€”').replace(/\n/g,'<br>');
      sStatus.value = o.status||'PENDING';
      setChip(o.status||'PENDING');
      sNote.value = o.resolutionNote||'';
      sDistance.textContent = (dist? (dist<1000?`${Math.round(dist)} Ù…`:`${(dist/1000).toFixed(1)} ÙƒÙ…`) : 'â€”');

      sMedia.innerHTML = '';
      if (o.afterImagePath){
        sMedia.innerHTML = `
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <img src="${o.imagePath||''}" alt="Ù‚Ø¨Ù„" style="width:100%;border-radius:10px">
            <img src="${o.afterImagePath||''}" alt="Ø¨Ø¹Ø¯" style="width:100%;border-radius:10px">
          </div>`;
      } else if (o.imagePath){
        sMedia.innerHTML = `<img src="${o.imagePath}" alt="Ù…Ø±ÙÙ‚" style="width:100%;border-radius:10px">`;
      } else {
        sMedia.innerHTML = `<div class="card-mini" style="text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚</div>`;
      }

      sheet.classList.add('open');
    }

    sheetClose.addEventListener('click', ()=> sheet.classList.remove('open'));
    let startY=0, currentY=0, dragging=false;
    function onStart(e){ dragging=true; startY = (e.touches?e.touches[0].clientY:e.clientY); sheet.style.transition='none'; }
    function onMove(e){
      if(!dragging) return;
      currentY = (e.touches?e.touches[0].clientY:e.clientY);
      const dy = Math.max(0, currentY - startY);
      sheet.style.transform = `translateY(${dy}px)`;
    }
    function onEnd(){
      if(!dragging) return;
      dragging=false; sheet.style.transition='';
      const dy = Math.max(0, currentY - startY);
      if (dy > 120){ sheet.classList.remove('open'); sheet.style.transform=''; }
      else { sheet.style.transform=''; }
    }
    sheetHandle.addEventListener('mousedown', onStart);
    sheetHandle.addEventListener('touchstart', onStart);
    window.addEventListener('mousemove', onMove);
    window.addEventListener('touchmove', onMove);
    window.addEventListener('mouseup', onEnd);
    window.addEventListener('touchend', onEnd);

    sSave.addEventListener('click', async ()=>{
      if (!currentDocId){ sheet.classList.remove('open'); return; }
      const newStatus = sStatus.value;
      if (newStatus==='COMPLETED' && !currentAfterData){
        const ok = confirm('Ø¥ØºÙ„Ø§Ù‚ ÙŠØªØ·Ù„Ø¨ ØµÙˆØ±Ø© "Ø¨Ø¹Ø¯". Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¯ÙˆÙ† ØµÙˆØ±Ø©ØŸ');
        if (!ok) return;
      }
      const payload = {
        status: newStatus,
        resolutionNote: sNote.value || `ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨ØªØ§Ø±ÙŠØ® ${new Date().toLocaleString('ar-SA')}`
      };
      if (currentAfterData) payload.afterImagePath = currentAfterData;

      try {
        if (FIREBASE_READY){
          await updateDoc(doc(db,'observations', currentDocId), payload);
        } else {
          const idx = observations.findIndex(x=>x.docId===currentDocId);
          if (idx>-1){ observations[idx] = { ...observations[idx], ...payload }; }
        }
        toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
        sheet.classList.remove('open');
        paint();
      } catch (e){
        console.error(e);
        toast('ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„');
      }
    });

    const legendBtn = document.getElementById('legendToggle');
    const legendBox = document.getElementById('legendBox');
    legendBtn.addEventListener('click', () => {
      legendBox.classList.toggle('hidden');
      legendBtn.classList.toggle('active');
      lucide.createIcons();
    });

    function ping(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 880;
        g.gain.value = 0.0001;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.05, ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.25);
        o.stop(ctx.currentTime + 0.26);
      }catch(e){}
    }

    const filterSheet = document.getElementById('filterSheet');
    const filterHandle = document.getElementById('filterHandle');
    let dragStartY = 0, dragY = 0, draggingFilter = false, sheetOpen = false;

    function setFilterState(open){
      sheetOpen = open;
      filterSheet.classList.toggle('open', open);
    }
    function onFilterStart(e){
      draggingFilter = true;
      dragStartY = (e.touches?e.touches[0].clientY:e.clientY);
      filterSheet.style.transition = 'none';
    }
    function onFilterMove(e){
      if(!draggingFilter) return;
      dragY = (e.touches?e.touches[0].clientY:e.clientY);
      const dy = Math.max(0, dragY - dragStartY);
      const base = sheetOpen ? 0 : (filterSheet.offsetHeight - 60);
      let translate = sheetOpen ? dy : (filterSheet.offsetHeight - 60 - dy);
      translate = Math.max(0, Math.min(filterSheet.offsetHeight - 60, translate));
      filterSheet.style.transform = `translateY(${translate}px)`;
    }
    function onFilterEnd(){
      if(!draggingFilter) return;
      draggingFilter = false;
      filterSheet.style.transition = '';
      const matrix = window.getComputedStyle(filterSheet).transform;
      let current = 0;
      if (matrix && matrix !== 'none'){
        const values = matrix.split('(')[1].split(')')[0].split(',');
        current = parseFloat(values[5] || 0);
      }
      const threshold = (filterSheet.offsetHeight - 60)/2;
      if (current > threshold){ setFilterState(false); filterSheet.style.transform = `translateY(${filterSheet.offsetHeight - 60}px)`; }
      else { setFilterState(true); filterSheet.style.transform = `translateY(0)`; }
    }

    filterHandle.addEventListener('mousedown', onFilterStart);
    filterHandle.addEventListener('touchstart', onFilterStart);
    window.addEventListener('mousemove', onFilterMove);
    window.addEventListener('touchmove', onFilterMove);
    window.addEventListener('mouseup', onFilterEnd);
    window.addEventListener('touchend', onFilterEnd);
    document.querySelector('.filter-head').addEventListener('click', ()=> setFilterState(!sheetOpen));

    function toast(text){
      const t=document.getElementById('toast'); t.textContent=text; t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 1800);
    }
    function fileToBase64(file){
      return new Promise((res,rej)=>{
        const reader = new FileReader();
        reader.onload = e=> res(e.target.result);
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });
    }

    function drawFrame(){
      frameRing.clearLayers();
      const center = map.getCenter();
      L.circle([center.lat, center.lng], { radius: 80, color:'#18A5A2', fillColor:'var(--map-ring)', fillOpacity:0.06, weight:1 }).addTo(frameRing);
    }
    map.on('moveend', drawFrame);
    drawFrame();

    startLive();
    drawMe();
    lucide.createIcons();
  </script>
</body>
</html>
