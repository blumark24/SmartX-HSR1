<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart HSR | الخريطة الميدانية الذكية</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Icons & Font -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --teal:#18A5A2; --navy:#0A1931; --gray:#F7F9FC;
      --red:#EF4444; --amber:#F59E0B; --green:#10B981;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Tajawal',sans-serif;background:var(--gray);color:var(--navy);overflow:hidden;}
    #map{width:100%;height:100vh}

    /* header */
    .app-header{
      position:absolute;top:0;inset-inline:0;z-index:1000;
      background:#fff;border-bottom:3px solid #e6f5f4;
      padding:10px 14px;display:flex;align-items:center;gap:10px;
    }
    .brand{font-weight:900}.brand span{color:var(--teal)}
    .btn{display:inline-flex;align-items:center;gap:6px;border:none;
      border-radius:999px;padding:8px 14px;cursor:pointer;
      font-weight:800;transition:.2s;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .btn-primary{background:var(--teal);color:#fff}
    .btn-soft{background:#fff;color:var(--navy);border:1px solid #e5e7eb}
    .btn:hover{transform:translateY(-1px)}

    /* modal responsive */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:2000;transition:.3s;}
    .modal.open{display:flex;}
    .modal-content{
      background:#fff;width:min(600px,95vw);border-radius:18px;padding:16px;
      box-shadow:0 12px 40px rgba(0,0,0,.25);
      max-height:90vh;overflow:auto;
      animation:pop .3s ease;
    }
    @keyframes pop{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}

    /* bottom sheet mode for mobile */
    @media (max-width:720px){
      .modal{align-items:flex-end;}
      .modal-content{
        width:100%;border-radius:18px 18px 0 0;
        max-height:92vh;animation:slideUp .35s ease;
      }
      @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    }

    .modal-header{display:flex;align-items:center;gap:8px;
      border-bottom:1px solid #eee;padding-bottom:8px;margin-bottom:10px;}
    .pill{padding:4px 10px;border-radius:999px;font-weight:800;}
    .pill.red{background:#fee2e2;color:#991b1b}
    .pill.amber{background:#fef3c7;color:#92400e}
    .pill.green{background:#dcfce7;color:#065f46}

    .field{display:flex;flex-direction:column;gap:6px;margin:6px 0}
    textarea,select,input[type=file]{border:1px solid #e5e7eb;border-radius:10px;padding:8px;font-family:inherit;}
    img{border-radius:12px;width:100%;object-fit:cover}

    .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px;}
    .toast{position:fixed;bottom:12px;inset-inline-start:12px;background:var(--navy);color:#fff;
      padding:10px 12px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.3);display:none;}
    .toast.show{display:block;}
  </style>
</head>
<body>
  <header class="app-header">
    <div class="brand">Smart HSR <span>Live Map</span></div>
    <button id="locBtn" class="btn btn-primary"><i data-lucide="crosshair"></i> موقعي</button>
    <a href="manager.html" class="btn btn-soft"><i data-lucide="layout-dashboard"></i>لوحة المدير</a>
  </header>

  <div id="map"></div>

  <!-- Modal -->
  <div id="smartModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <i data-lucide="file-search"></i>
        <h3 id="modalTitle" style="margin:0;font-weight:900;">تفاصيل الملاحظة</h3>
        <span id="modalChip" class="pill" style="margin-inline-start:auto"></span>
      </div>
      <div class="field">
        <label>العنوان</label>
        <div id="mTitle" style="font-weight:700"></div>
      </div>
      <div class="field">
        <label>المسافة من موقعي</label>
        <div id="mDistance" style="font-weight:700"></div>
      </div>
      <div class="field">
        <label>الوصف</label>
        <div id="mDetails" style="line-height:1.8"></div>
      </div>
      <div id="mMedia" class="field"></div>
      <div class="field">
        <label>الحالة</label>
        <select id="mStatus">
          <option value="PENDING">جديد</option>
          <option value="IN_PROGRESS">قيد التنفيذ</option>
          <option value="COMPLETED">مغلق</option>
        </select>
      </div>
      <div class="field">
        <label>صورة بعد الإصلاح</label>
        <input id="afterInput" type="file" accept="image/*">
      </div>
      <div class="field">
        <label>المذكرة الختامية</label>
        <textarea id="mNote" rows="3"></textarea>
      </div>
      <div class="modal-actions">
        <button id="saveBtn" class="btn btn-primary"><i data-lucide="save"></i> حفظ</button>
        <button id="closeBtn" class="btn btn-soft"><i data-lucide="x"></i> إغلاق</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">تم الحفظ بنجاح</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBfClVxFIXgUXL4olEv5SepUDtzk0dq3lo",
      authDomain: "gen-lang-client-0349944917.firebaseapp.com",
      projectId: "gen-lang-client-0349944917",
      storageBucket: "gen-lang-client-0349944917.firebasestorage.app",
      messagingSenderId: "883065484771",
      appId: "1:883065484771:web:c907bb5a51f68caad75cd6"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const map = L.map('map').setView([24.7136, 46.6753], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const markers = new Map();
    let lastMe = [24.7136,46.6753];

    function haversine(a,b){const toRad=d=>d*Math.PI/180;const [la1,lo1]=a,[la2,lo2]=b;
      const R=6371000,dLat=toRad(la2-la1),dLon=toRad(lo2-lo1);
      const s1=Math.sin(dLat/2),s2=Math.sin(dLon/2);
      return 2*R*Math.asin(Math.sqrt(s1*s1+Math.cos(toRad(la1))*Math.cos(toRad(la2))*s2*s2));}

    const modal=document.getElementById('smartModal');
    const mTitle=document.getElementById('mTitle');
    const mDetails=document.getElementById('mDetails');
    const mDistance=document.getElementById('mDistance');
    const mStatus=document.getElementById('mStatus');
    const mNote=document.getElementById('mNote');
    const mMedia=document.getElementById('mMedia');
    const modalChip=document.getElementById('modalChip');
    const afterInput=document.getElementById('afterInput');
    const saveBtn=document.getElementById('saveBtn');
    const closeBtn=document.getElementById('closeBtn');
    const toast=document.getElementById('toast');
    let currentDoc=null, afterData=null;

    function chipColor(s){modalChip.className='pill '+(s==='PENDING'?'red':s==='IN_PROGRESS'?'amber':'green');
      modalChip.textContent=s==='PENDING'?'جديد':s==='IN_PROGRESS'?'قيد التنفيذ':'مغلق';}

    function openModal(o){
      currentDoc=o;
      mTitle.textContent=o.title||'—';
      mDetails.textContent=o.details||'—';
      mStatus.value=o.status||'PENDING';
      mNote.value=o.resolutionNote||'';
      chipColor(o.status);
      const dist=haversine(lastMe,o.latlon);
      mDistance.textContent=`${dist<1000?dist.toFixed(0)+' م':(dist/1000).toFixed(1)+' كم'}`;
      mMedia.innerHTML = o.afterImagePath ?
        `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <img src="${o.imagePath}" alt="قبل"><img src="${o.afterImagePath}" alt="بعد"></div>` :
        `<img src="${o.imagePath}" alt="مرفق">`;
      modal.classList.add('open');
    }

    closeBtn.onclick=()=>modal.classList.remove('open');
    modal.onclick=e=>{if(e.target===modal)modal.classList.remove('open');}
    afterInput.onchange=async e=>{
      const f=e.target.files[0];if(!f)return;
      afterData=await new Promise(r=>{const R=new FileReader();R.onload=()=>r(R.result);R.readAsDataURL(f);});
    }

    saveBtn.onclick=async ()=>{
      if(!currentDoc)return;
      const newData={status:mStatus.value,resolutionNote:mNote.value||''};
      if(afterData)newData.afterImagePath=afterData;
      try{await updateDoc(doc(db,'observations',currentDoc.id),newData);
        showToast('تم الحفظ بنجاح');modal.classList.remove('open');
      }catch(e){showToast('تعذر الحفظ');}
    }

    function showToast(t){toast.textContent=t;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),2000);}

    // markers from Firestore
    onSnapshot(collection(db,'observations'),snap=>{
      snap.forEach(d=>{
        const data=d.data();const [lat,lon]=data.location.split(',').map(Number);
        const o={id:d.id,title:data.title,details:data.details,imagePath:data.imagePath,afterImagePath:data.afterImagePath,status:data.status,resolutionNote:data.resolutionNote,latlon:[lat,lon]};
        if(!markers.has(d.id)){
          const m=L.marker([lat,lon]).addTo(map);
          m.on('click',()=>openModal(o));
          markers.set(d.id,m);
        }
      });
    });

    // geolocation
    document.getElementById('locBtn').onclick=()=>{
      navigator.geolocation.getCurrentPosition(pos=>{
        lastMe=[pos.coords.latitude,pos.coords.longitude];
        L.marker(lastMe).addTo(map);
        map.setView(lastMe,14);
      });
    };

    lucide.createIcons();
  </script>
</body>
</html>
