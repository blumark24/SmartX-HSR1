<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Smart HSR | الخريطة الميدانية الذكية</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css">
<style>
  :root{--navy:#0A1931;--teal:#18A5A2;--light:#F7F9FC;--shadow:rgba(10,25,49,.1)}
  *{box-sizing:border-box}
  body{font-family:'Tajawal',sans-serif;background:var(--light);color:#1f2937;margin:0}
  .app{display:flex;flex-direction:column;height:100vh}
  .header{background:#fff;border-bottom:6px solid #e6fffb;box-shadow:0 6px 20px var(--shadow);padding:.6rem 1rem;display:flex;align-items:center;gap:.6rem;position:sticky;top:0;z-index:1000}
  .brand{display:flex;align-items:center;gap:.6rem}
  .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--teal),#10B981);box-shadow:0 4px 12px rgba(24,165,162,.4)}
  .title{font-weight:800;font-size:1.05rem;color:var(--navy)}
  .controls{display:flex;flex-wrap:wrap;gap:.5rem;margin-inline-start:auto}
  .btn,.select{border:0;border-radius:999px;padding:.55rem .9rem;font-weight:700;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,.08);background:#fff;color:#0f172a}
  .btn:hover{transform:translateY(-1px)}
  .btn-primary{background:var(--teal);color:#fff}
  .toggle{display:flex;align-items:center;gap:.45rem;padding:.45rem .75rem;border-radius:999px;background:#0A1931;color:#fff;font-weight:800}
  .toggle input{accent-color:#22c55e;transform:scale(1.1)}
  .metrics{display:flex;gap:.6rem;padding:.6rem 1rem;background:#fff;border-bottom:1px solid #eef2f7}
  .pill{flex:1;min-width:140px;background:linear-gradient(135deg,#f8fafc,#eef7f6);border:1px solid #e8f3f2;border-radius:18px;padding:.55rem .8rem;display:flex;align-items:center;justify-content:space-between}
  .pill .v{font-size:1.25rem;font-weight:900;color:var(--navy)}
  #map{flex:1}
  .legend{position:absolute;inset-inline-end:10px;bottom:10px;background:#fff;border-radius:12px;box-shadow:0 8px 20px var(--shadow);padding:.6rem .8rem;z-index:500;font-size:.85rem}
  .legend .row{display:flex;align-items:center;gap:.4rem;margin:.2rem 0}
  .dot{width:12px;height:12px;border-radius:50%}
  .card{position:absolute;inset-inline-start:10px;bottom:10px;background:#fff;border-radius:16px;box-shadow:0 10px 30px var(--shadow);padding:.8rem;min-width:240px;max-width:320px;z-index:500}
  .card h4{margin:.2rem 0 .4rem 0;font-size:1rem;color:var(--navy)}
  .card p{margin:.15rem 0;font-size:.9rem;color:#334155}
  .chip{display:inline-block;padding:.2rem .55rem;border-radius:999px;font-size:.75rem;font-weight:800;color:#fff}
  .status-PENDING{background:#ef4444}
  .status-IN_PROGRESS{background:#f59e0b}
  .status-COMPLETED{background:#10b981}
  .map-topbar{position:absolute;top:12px;inset-inline-start:12px;z-index:500;display:flex;gap:.4rem;flex-wrap:wrap}
  .panel{background:#fff;border-radius:14px;box-shadow:0 8px 20px var(--shadow);padding:.5rem .6rem;display:flex;gap:.4rem;align-items:center}
  .select{padding:.45rem .8rem}
  @media (max-width:640px){.controls{display:none}}
</style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <div class="header">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">الخريطة الميدانية الذكية</div>
    </div>
    <div class="controls">
      <button class="btn" onclick="goDashboard()">لوحة القيادة</button>
      <button class="btn" onclick="refreshNow()">تحديث يدوي</button>
      <div class="toggle"><label>تحديث تلقائي</label><input id="autoRefresh" type="checkbox" checked></div>
    </div>
  </div>

  <!-- METRICS -->
  <div class="metrics" id="metrics">
    <div class="pill"><span>جديد</span><span class="v" id="mNew">0</span></div>
    <div class="pill"><span>قيد التنفيذ</span><span class="v" id="mProg">0</span></div>
    <div class="pill"><span>مغلق</span><span class="v" id="mDone">0</span></div>
    <div class="pill"><span>موثّق بالصور</span><span class="v" id="mPic">0</span></div>
  </div>

  <!-- MAP -->
  <div id="map"></div>

  <!-- LEGEND -->
  <div class="legend">
    <div class="row"><span class="dot" style="background:#ef4444"></span> جديد</div>
    <div class="row"><span class="dot" style="background:#f59e0b"></span> قيد التنفيذ</div>
    <div class="row"><span class="dot" style="background:#10b981"></span> مغلق</div>
  </div>

  <!-- DETAILS CARD -->
  <div class="card" id="detailCard" style="display:none">
    <h4 id="dTitle">—</h4>
    <p><b>التصنيف:</b> <span id="dType">—</span></p>
    <p><b>الموقع:</b> <span id="dLoc">—</span></p>
    <p><b>التاريخ:</b> <span id="dDate">—</span></p>
    <p><span id="dStatus" class="chip status-PENDING">—</span> <span id="dId" style="font-weight:800;color:#475569;margin-inline-start:.35rem"></span></p>
    <div style="margin-top:.45rem;display:flex;gap:.4rem;flex-wrap:wrap">
      <button class="btn-primary btn" onclick="openInDashboard()">فتح التفاصيل</button>
      <button class="btn" onclick="closeCard()">إغلاق</button>
    </div>
  </div>

  <!-- MAP TOP FILTERS -->
  <div class="map-topbar">
    <div class="panel">
      <select id="filterStatus" class="select" onchange="applyFilters()">
        <option value="ALL">كل الحالات</option>
        <option value="PENDING">جديد</option>
        <option value="IN_PROGRESS">قيد التنفيذ</option>
        <option value="COMPLETED">مغلق</option>
      </select>
      <select id="filterType" class="select" onchange="applyFilters()">
        <option value="ALL">كل التصنيفات</option>
        <option value="QUALITY">جودة</option>
        <option value="MAINTENANCE">صيانة</option>
        <option value="SAFETY">سلامة</option>
        <option value="ENVIRONMENT">بيئة</option>
      </select>
      <button class="btn" id="locBtn">موقعي</button>
    </div>
    <div class="panel">
      <button class="btn" onclick="setBase('street')">خريطة شارع</button>
      <button class="btn" onclick="setBase('sat')">صور أقمار</button>
    </div>
  </div>
</div>

<!-- LIBS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script type="module">
/* ========= Firebase (نفس إعداداتك) ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfClVxFIXgUXL4olEv5SepUDtzk0dq3lo",
  authDomain: "gen-lang-client-0349944917.firebaseapp.com",
  projectId: "gen-lang-client-0349944917",
  storageBucket: "gen-lang-client-0349944917.firebasestorage.app",
  messagingSenderId: "883065484771",
  appId: "1:883065484771:web:c907bb5a51f68caad75cd6",
  measurementId: "G-V8WG5M8V5B"
};

let app, db;
try{ app = initializeApp(firebaseConfig); db = getFirestore(app); }
catch(e){ console.warn('Firebase init failed, using local seed.', e); }

/* ========= خريطة شبيهة ببلدي ========= */
const map = L.map('map', {
  center: [24.7136, 46.6753], // الرياض كنقطة بداية حقيقية
  zoom: 10,
  zoomControl: false
});
L.control.zoom({ position: 'topleft' }).addTo(map);

// طبقات أساس (Street/Satellite) بسيطة بلا مفاتيح
const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution: '&copy; OpenStreetMap'
});
const sat = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
  attribution:'&copy; Esri'
});
let base = street.addTo(map);
function setBase(kind){
  if(kind==='street'){ map.removeLayer(base); base = street.addTo(map); }
  else { map.removeLayer(base); base = sat.addTo(map); }
}
window.setBase = setBase;

/* ========= أدوات واجهة ========= */
document.getElementById('locBtn').onclick = ()=> {
  map.locate({ setView:true, maxZoom:16 });
};
map.on('locationerror', ()=> alert('تعذر تحديد الموقع'));
function goDashboard(){ window.location.href = 'dashboard.html'; }
window.goDashboard = goDashboard;

const autoRefreshEl = document.getElementById('autoRefresh');
autoRefreshEl.addEventListener('change', ()=> scheduleAuto());
function refreshNow(){ loadData(true); }
window.refreshNow = refreshNow;

/* ========= ألوان الحاله ========= */
const COLORS = {
  PENDING:   '#ef4444',
  IN_PROGRESS:'#f59e0b',
  COMPLETED: '#10b981'
};

/* ========= قراءة البيانات ورسمها ========= */
let markers = [];
let currentSelected = null;
async function fetchObservations(){
  if(!db){ // seed محلي إذا لا يوجد اتصال
    return [
      { docId:'local-4', id:4,  type:'QUALITY',     date:'2025-09-20', title:'تآكل لوحة إرشادية', status:'PENDING',      location:'24.7743, 46.7386' },
      { docId:'local-3', id:3,  type:'MAINTENANCE', date:'2025-09-25', title:'عطل تبريد رئيسي',   status:'IN_PROGRESS', location:'24.6869, 46.7223' },
      { docId:'local-2', id:2,  type:'QUALITY',     date:'2025-09-28', title:'تصدع أسفلت',        status:'COMPLETED',   location:'24.6282, 46.7436' },
      { docId:'local-1', id:1,  type:'SAFETY',      date:'2025-10-01', title:'PPE غير مكتمل',     status:'PENDING',      location:'24.8001, 46.6009' }
    ];
  }
  const q = query(collection(db,'observations'), orderBy('createdAt','desc'));
  const snap = await getDocs(q);
  const rows = [];
  snap.forEach(d=>{
    const o = d.data();
    rows.push({
      docId: d.id,
      id: o.displayId || o.id || '—',
      type: o.type || 'MAINTENANCE',
      date: o.date || '—',
      title: o.title || '—',
      status: o.status || 'PENDING',
      location: o.location || '', // "lat, lon"
    });
  });
  return rows;
}

function clearMarkers(){
  markers.forEach(m=> map.removeLayer(m));
  markers = [];
}

function makeDot(color){
  const svg = encodeURIComponent(
    `<svg xmlns='http://www.w3.org/2000/svg' width='28' height='28'>
      <circle cx='14' cy='14' r='9' fill='${color}'/>
      <circle cx='14' cy='14' r='12' fill='white' fill-opacity='.7'/>
    </svg>`
  );
  return L.icon({ iconUrl:`data:image/svg+xml,${svg}`, iconSize:[28,28], iconAnchor:[14,14] });
}

let allData = [];
async function loadData(fit=false){
  const data = await fetchObservations();
  allData = data;
  renderMetrics(data);
  applyFilters(fit);
}

function renderMetrics(data){
  const nNew  = data.filter(d=>d.status==='PENDING').length;
  const nProg = data.filter(d=>d.status==='IN_PROGRESS').length;
  const nDone = data.filter(d=>d.status==='COMPLETED').length;
  const nPic  = 0; // يمكن لاحقاً احتسابه إن احتجت imagePath
  mNew.textContent  = nNew;
  mProg.textContent = nProg;
  mDone.textContent = nDone;
  mPic.textContent  = nPic;
}

function parseLatLng(str){
  if(!str) return null;
  const [lat,lon] = String(str).split(',').map(s=>parseFloat(s.trim()));
  if(Number.isFinite(lat)&&Number.isFinite(lon)) return {lat,lon};
  return null;
}

function applyFilters(fit=false){
  clearMarkers();
  const fs = document.getElementById('filterStatus').value;
  const ft = document.getElementById('filterType').value;
  const filtered = allData.filter(r=>{
    const okS = (fs==='ALL' || r.status===fs);
    const okT = (ft==='ALL' || r.type===ft);
    return okS && okT;
  });
  const group = [];
  filtered.forEach(r=>{
    const ll = parseLatLng(r.location);
    if(!ll) return;
    const icon = makeDot(COLORS[r.status] || '#64748b');
    const m = L.marker([ll.lat,ll.lon], { icon }).addTo(map);
    m.on('click', ()=> showCard(r));
    markers.push(m); group.push([ll.lat,ll.lon]);
  });
  if(fit && group.length){ map.fitBounds(group, { padding:[40,40] }); }
}
window.applyFilters = applyFilters;

/* ========= بطاقة التفاصيل ========= */
function showCard(r){
  currentSelected = r;
  dTitle.textContent = r.title || '—';
  dType.textContent  = r.type  || '—';
  dLoc.textContent   = r.location || '—';
  dDate.textContent  = r.date  || '—';
  dId.textContent    = `#${r.id}`;
  dStatus.textContent = (r.status==='PENDING'?'جديد':r.status==='IN_PROGRESS'?'قيد التنفيذ':'مغلق');
  dStatus.className = `chip status-${r.status}`;
  detailCard.style.display = 'block';
}
function closeCard(){ detailCard.style.display = 'none'; }
window.closeCard = closeCard;

function openInDashboard(){
  if(!currentSelected) return;
  // نمرر displayId كمعامل للاستفادة منه في dashboard (يمكنك قراءة query param هناك)
  const id = encodeURIComponent(currentSelected.id);
  window.location.href = `dashboard.html?id=${id}`;
}
window.openInDashboard = openInDashboard;

/* ========= جدولة التحديث ========= */
let timer=null;
function scheduleAuto(){
  if(timer){ clearInterval(timer); timer=null; }
  if(autoRefreshEl.checked){
    timer = setInterval(()=> loadData(false), 60000); // كل دقيقة
  }
}
scheduleAuto();

/* ========= بدء التشغيل ========= */
loadData(true);
</script>
</body>
</html>
