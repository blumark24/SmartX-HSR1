<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart HSR | الخريطة الميدانية الذكية</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Fonts & Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --color-navy:#0A1931;
      --color-teal:#18A5A2;
      --color-gray-bg:#F6F8FB;
      --shadow:0 10px 30px rgba(0,0,0,.12);
      --red:#EF4444;
      --amber:#F59E0B;
      --green:#10B981;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Tajawal',sans-serif;
      background:var(--color-gray-bg);
      color:var(--color-navy);
    }

    /* Header */
    .app-header{
      position:sticky;
      top:0;
      z-index:1000;
      background:#fff;
      border-bottom:3px solid #e6f5f4;
      padding:8px 10px;
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:space-between;
    }
    .brand{font-weight:900; letter-spacing:.5px; font-size:16px}
    .brand span{color:var(--color-teal)}
    .header-actions{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
    .btn{
      display:inline-flex; align-items:center; gap:6px;
      padding:7px 10px; border:none; border-radius:999px;
      font-weight:800; cursor:pointer; transition:.2s;
      font-size:12px; box-shadow:0 3px 6px rgba(0,0,0,.1)
    }
    .btn-primary{background:var(--color-teal); color:#fff}
    .btn-dark{background:var(--color-navy); color:#fff}
    .btn-soft{background:#fff; color:var(--color-navy); border:1px solid #dbe1ea}
    .btn:hover{transform:translateY(-1px)}
    .chip{background:#f1f5f9; padding:4px 10px; border-radius:999px; font-weight:700; font-size:11px}

    /* Map frame (Dark border, Balady style) */
    .map-frame{
      position:relative;
      margin:8px;
      border:10px solid #1a2438;
      background:#fff;
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 10px 25px rgba(0,0,0,.25), inset 0 0 10px rgba(255,255,255,.3);
    }

    /* Map container */
    #map{width:100%; height:calc(100vh - 100px)}

    /* Floating tools */
    .toolbar{
      position:absolute; top:14px; inset-inline-start:14px; z-index:900;
      display:flex; flex-direction:column; gap:10px;
    }
    .card{background:rgba(255,255,255,0.95); border:1px solid #e0e6ed; border-radius:14px; box-shadow:var(--shadow)}
    .tool-card{padding:8px 10px}
    .tool-row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .select, .range{
      border:1px solid #e2e8f0; border-radius:12px; padding:7px 8px;
      font-weight:600; background:#fff; color:#0a1931; font-size:12px
    }

    /* Legend */
    .legend{
      position:absolute; right:12px; bottom:12px; z-index:901;
      background:rgba(255,255,255,0.95);
      border:1px solid #e0e6ed;
      border-radius:12px;
      padding:8px 10px;
      font-size:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      transition:opacity .3s, transform .3s;
    }
    .legend.hidden{opacity:0; transform:translateY(8px); pointer-events:none}
    .legend .title{font-weight:900; margin-bottom:4px}
    .legend .item{display:flex; align-items:center; gap:6px; margin:3px 0}
    .dot{width:10px; height:10px; border-radius:50%}
    .dot.red{background:var(--red)}
    .dot.amber{background:var(--amber)}
    .dot.green{background:var(--green)}

    /* Marker */
    .pulse{
      width:14px; height:14px; border-radius:50%; position:relative;
      box-shadow:0 0 0 2px #fff, 0 3px 6px rgba(0,0,0,.3)
    }
    .pulse.red{background:var(--red)}
    .pulse.amber{background:var(--amber)}
    .pulse.green{background:var(--green)}
    .pulse.red::after, .pulse.amber::after{
      content:""; position:absolute; inset:0; border-radius:50%;
      box-shadow:0 0 0 0 currentColor; animation:pulse 1.8s infinite; opacity:.55
    }
    .pulse.red::after{color:var(--red)}
    .pulse.amber::after{color:var(--amber)}
    @keyframes pulse{0%{box-shadow:0 0 0 0 currentColor}70%{box-shadow:0 0 0 14px rgba(0,0,0,0)}100%{box-shadow:0 0 0 0 rgba(0,0,0,0)}}

    /* Modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:2000; padding:16px}
    .modal.open{display:flex}
    .modal-content{
      background:#fff; width:min(600px, 94vw);
      border-radius:16px; padding:14px;
      box-shadow:0 20px 60px rgba(0,0,0,.3);
      max-height:90vh; overflow-y:auto;
    }
    .modal-header{display:flex; align-items:center; gap:8px; border-bottom:1px solid #e2e8f0; padding-bottom:8px; margin-bottom:10px}
    .modal-actions{display:flex; gap:8px; margin-top:12px; justify-content:flex-end}
    .field{display:flex; flex-direction:column; gap:4px}
    textarea, select, input[type="file"]{border:1px solid #e2e8f0; border-radius:10px; padding:8px 10px; font-family:inherit}
    .pill{display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px}
    .pill.red{background:#fee2e2; color:#991b1b}
    .pill.amber{background:#fef3c7; color:#92400e}
    .pill.green{background:#dcfce7; color:#065f46}

    /* Toast */
    .toast{position:fixed; bottom:12px; inset-inline-start:12px; background:#0a1931; color:#fff; padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); z-index:3000; display:none}
    .toast.show{display:block}
  </style>
</head>
<body>

  <!-- Header -->
  <header class="app-header">
    <div class="brand">Smart HSR <span>Live&nbsp;Map</span></div>
    <div id="nearStats" class="chip" title="حول موقعي الآن">
      <i data-lucide="map-pin" class="w-4 h-4"></i>
      <span id="meDistLabel">—</span> |
      <i data-lucide="alert-triangle" class="w-4 h-4"></i>قريب:
      <b id="nearCount">0</b>
    </div>
    <div class="header-actions">
      <button id="locBtn" class="btn btn-primary" title="تحديد موقعي"><i data-lucide="crosshair"></i></button>
     
      <a href="index.html" class="btn btn-soft" title="اللوحة التنفيذية"><i data-lucide="layout-dashboard"></i></a>
    </div>
  </header>

  <!-- Map frame -->
  <div class="map-frame">
    <div id="map"></div>

    <div class="toolbar">
      <div class="tool-card card">
        <div class="tool-row">
          <select id="statusFilter" class="select">
            <option value="ALL">كل الحالات</option>
            <option value="PENDING">جديد</option>
            <option value="IN_PROGRESS">قيد التنفيذ</option>
            <option value="COMPLETED">مغلق</option>
          </select>
          <label class="select" style="display:flex;align-items:center;gap:6px;">
            <i data-lucide="radar" class="w-4 h-4"></i>
            نصف القطر:
            <input id="radiusInput" type="range" min="500" max="5000" step="100" class="range" style="width:150px">
            <span id="radiusLabel" style="font-weight:800">2000 م</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Legend -->
    <div id="legend" class="legend card">
      <div class="title">أسطورة الحالات</div>
      <div class="item"><span class="dot red"></span> جديد</div>
      <div class="item"><span class="dot amber"></span> قيد التنفيذ</div>
      <div class="item"><span class="dot green"></span> مغلق</div>
    </div>
  </div>

  <!-- Modal -->
  <div id="smartModal" class="modal" role="dialog">
    <div class="modal-content">
      <div class="modal-header">
        <i data-lucide="file-search" class="w-5 h-5"></i>
        <h3 id="modalTitle" style="margin:0;font-weight:900">تفاصيل الملاحظة</h3>
        <span id="modalChip" class="pill" style="margin-inline-start:auto"></span>
      </div>
      <div id="modalBody" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div class="field">
          <label>العنوان</label>
          <div id="mTitle" class="card" style="padding:10px;font-weight:800"></div>
        </div>
        <div class="field">
          <label>المسافة من موقعي</label>
          <div id="mDistance" class="card" style="padding:10px;font-weight:800"></div>
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>الوصف</label>
          <div id="mDetails" class="card" style="padding:12px;line-height:1.8"></div>
        </div>
        <div class="field">
          <label>الحالة</label>
          <select id="mStatus" class="select">
            <option value="PENDING">جديد</option>
            <option value="IN_PROGRESS">قيد التنفيذ</option>
            <option value="COMPLETED">مغلق</option>
          </select>
        </div>
        <div class="field">
          <label>صورة بعد الإصلاح</label>
          <input id="afterInput" type="file" accept="image/*">
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>المذكرة الختامية</label>
          <textarea id="mNote" rows="3" placeholder="اكتب المذكرة هنا..."></textarea>
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>المرفق الحالي</label>
          <div id="mMedia" class="card" style="padding:8px"></div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="saveBtn" class="btn btn-primary"><i data-lucide="save"></i>حفظ</button>
        <button id="closeBtn" class="btn btn-soft"><i data-lucide="x"></i>إغلاق</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">تم الحفظ بنجاح</div>

  <!-- Firebase + Map -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {apiKey:"AIzaSyBfClVxFIXgUXL4olEv5SepUDtzk0dq3lo",authDomain:"gen-lang-client-0349944917.firebaseapp.com",projectId:"gen-lang-client-0349944917",storageBucket:"gen-lang-client-0349944917.firebasestorage.app",messagingSenderId:"883065484771",appId:"1:883065484771:web:c907bb5a51f68caad75cd6"};
    let app, db, FIREBASE_READY=false;
    try { app = initializeApp(firebaseConfig); db = getFirestore(app); FIREBASE_READY=true; } catch(e){ console.warn(e); }

    const map = L.map('map',{zoomControl:false});
    map.setView([24.7136,46.6753],10);
    L.control.zoom({position:'topright'}).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

    const markerIcon = (status)=>L.divIcon({html:`<div class="pulse ${status==='PENDING'?'red':status==='IN_PROGRESS'?'amber':'green'}"></div>`,className:'',iconSize:[16,16],iconAnchor:[8,8]});

    let meMarker=null, meCircle=null, lastMe=[24.7136,46.6753];
    const radiusInput=document.getElementById('radiusInput'),radiusLabel=document.getElementById('radiusLabel');
    radiusInput.value=2000;
    function drawMe(){
      const r=parseInt(radiusInput.value||2000,10);
      if(meMarker)meMarker.remove();
      if(meCircle)meCircle.remove();
      meMarker=L.marker(lastMe,{icon:L.divIcon({html:'<div class="pulse amber" style="width:16px;height:16px"></div>',className:'',iconSize:[16,16],iconAnchor:[8,8]})}).addTo(map);
      meCircle=L.circle(lastMe,{radius:r,color:'#18A5A2',fillColor:'#18A5A2',fillOpacity:0.08,weight:2}).addTo(map);
    }

    function haversine(a,b){const toRad=d=>d*Math.PI/180;const[lat1,lon1]=a,[lat2,lon2]=b;const R=6371000;const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);const s1=Math.sin(dLat/2),s2=Math.sin(dLon/2);const c=2*Math.asin(Math.sqrt(s1*s1+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*s2*s2));return R*c;}
    const statusFilter=document.getElementById('statusFilter'),nearCountEl=document.getElementById('nearCount'),meDistLabel=document.getElementById('meDistLabel');
    const fmtMeters=m=>m<1000?`${Math.round(m)} م`:`${(m/1000).toFixed(1)} كم`;
    const markers=new Map();let observations=[];

    function paint(){
      drawMe();const filter=statusFilter.value;const r=parseInt(radiusInput.value,10);radiusLabel.textContent=`${r} م`;
      let near=0;const presentIds=new Set();
      for(const o of observations){
        if(!o.location)continue;
        const[lat,lon]=o.location.split(',').map(n=>parseFloat(n.trim()));if(Number.isNaN(lat))continue;
        if(filter!=='ALL'&&o.status!==filter)continue;
        const dist=haversine(lastMe,[lat,lon]);if(dist<=r)near++;
        let m=markers.get(o.docId);
        if(!m){m=L.marker([lat,lon],{icon:markerIcon(o.status)}).addTo(map);m.bindTooltip(o.title||'',{direction:'top',offset:[0,-10]});m.on('click',()=>openModalFor(o,dist));markers.set(o.docId,m);}else{m.setIcon(markerIcon(o.status));m.setLatLng([lat,lon]);}
        presentIds.add(o.docId);
      }
      for(const[id,m]of markers){if(!presentIds.has(id)){m.remove();markers.delete(id);}}
      nearCountEl.textContent=near;meDistLabel.textContent=`نطاقي: ${fmtMeters(r)}`;
    }

    async function startLive(){
      if(!FIREBASE_READY){observations=[{docId:'1',id:1,title:'هبوط بسيط',status:'PENDING',details:'تم رصده ميدانيًا',location:'24.774265,46.738586',imagePath:'https://picsum.photos/600/400?1'}];paint();return;}
      const q=query(collection(db,'observations'),orderBy('createdAt','desc'));
      onSnapshot(q,snap=>{const arr=[];snap.forEach(d=>{const data=d.data();arr.push({docId:d.id,id:data.displayId||0,title:data.title||'—',status:data.status||'PENDING',details:data.details||'',location:data.location||'',imagePath:data.imagePath||null});});observations=arr;paint();});
    }

    const locBtn=document.getElementById('locBtn'),centerBtn=document.getElementById('centerBtn');let watchId=null;
    function startWatch(){if(!navigator.geolocation){alert('لا يدعم الموقع');return;}if(watchId!==null)return;watchId=navigator.geolocation.watchPosition(pos=>{lastMe=[pos.coords.latitude,pos.coords.longitude];paint();});}
    locBtn.addEventListener('click',()=>{startWatch();map.setView(lastMe,14,{animate:true});});
    centerBtn.addEventListener('click',()=>map.setView(lastMe,14,{animate:true}));
    statusFilter.addEventListener('change',paint);radiusInput.addEventListener('input',paint);

    const modal=document.getElementById('smartModal'),closeBtn=document.getElementById('closeBtn'),saveBtn=document.getElementById('saveBtn'),mStatus=document.getElementById('mStatus'),mTitleEl=document.getElementById('mTitle'),mDetails=document.getElementById('mDetails'),mMedia=document.getElementById('mMedia'),mNote=document.getElementById('mNote'),mDistance=document.getElementById('mDistance'),modalChip=document.getElementById('modalChip');
    let currentDocId=null;function setChip(status){modalChip.className='pill '+(status==='PENDING'?'red':status==='IN_PROGRESS'?'amber':'green');modalChip.textContent=status==='PENDING'?'جديد':status==='IN_PROGRESS'?'قيد التنفيذ':'مغلق';}
    function openModalFor(o,dist){currentDocId=o.docId;mTitleEl.textContent=o.title;mDetails.textContent=o.details;mStatus.value=o.status;setChip(o.status);mNote.value='';mDistance.textContent=fmtMeters(dist);mMedia.innerHTML=o.imagePath?`<img src="${o.imagePath}" style="width:100%;border-radius:10px">`:'—';modal.classList.add('open');}
    closeBtn.onclick=()=>modal.classList.remove('open');
    modal.onclick=e=>{if(e.target===modal)modal.classList.remove('open');};
    saveBtn.onclick=()=>{modal.classList.remove('open');showToast('تم الحفظ بنجاح');};
    const legend=document.getElementById('legend');let legendTimer=null;function showLegend(){legend.classList.remove('hidden');if(legendTimer)clearTimeout(legendTimer);legendTimer=setTimeout(()=>legend.classList.add('hidden'),3000);}
    showLegend();['movestart','zoomstart','click'].forEach(evt=>map.on(evt,showLegend));
    const toast=document.getElementById('toast');function showToast(t){toast.textContent=t;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),1600);}
    startLive();drawMe();lucide.createIcons();
  </script>
</body>
</html>
