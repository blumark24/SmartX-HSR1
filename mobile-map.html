<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart HSR | الخريطة الميدانية الذكية</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Fonts & Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --color-navy:#0A1931; --color-teal:#18A5A2; --color-light-teal:#ACE2E1;
      --color-gray-bg:#F7F9FC; --shadow:0 10px 30px rgba(0,0,0,.12);
      --red:#EF4444; --amber:#F59E0B; --green:#10B981;
      --frame:#dbe9e7; --frame-dark:#b7cfcb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:'Tajawal',sans-serif; background:var(--color-gray-bg); color:var(--color-navy)}
    a{color:inherit; text-decoration:none}

    /* Header */
    .app-header{
      position:sticky; top:0; z-index:1000;
      background:#fff; border-bottom:4px solid #e6f5f4;
      padding:12px 16px; display:flex; align-items:center; gap:10px;
    }
    .brand{font-weight:900; letter-spacing:.5px}
    .brand span{color:var(--color-teal)}
    .chip{background:#f1f5f9; padding:6px 12px; border-radius:999px; font-weight:800}
    .header-actions{margin-inline-start:auto; display:flex; gap:8px; align-items:center}
    .btn{display:inline-flex; align-items:center; gap:6px; padding:10px 14px; border:none; border-radius:999px; cursor:pointer; font-weight:800; transition:.2s; box-shadow:0 4px 10px rgba(10,25,49,.08)}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--color-teal); color:#fff}
    .btn-dark{background:var(--color-navy); color:#fff}
    .btn-soft{background:#fff; color:var(--color-navy); border:1px solid #e2e8f0}
    .counter{display:flex; gap:8px; flex-wrap:wrap}
    .counter .stat{background:#fff; border:1px solid #e2e8f0; border-radius:14px; padding:8px 12px; font-weight:800; display:flex; align-items:center; gap:6px}

    /* Map frame (Balady-like) */
    .map-shell{
      padding:14px; max-width:1600px; margin:14px auto;
    }
    .map-frame{
      background:#fff;
      border:1px solid var(--frame);
      border-radius:18px;
      box-shadow:0 12px 30px rgba(0,0,0,.08);
      overflow:hidden;
      position:relative;
    }
    .frame-topbar{
      height:42px; background:linear-gradient(90deg, var(--light-teal,#e7f7f6) 0%, #eaf6f3 40%, #ffffff 100%);
      border-bottom:1px solid var(--frame);
      display:flex; align-items:center; gap:10px; padding:0 12px;
    }
    .frame-topbar .title{
      font-weight:900; color:#0a1931; display:flex; align-items:center; gap:8px;
    }
    .frame-topbar .title i{opacity:.8}
    .frame-border{
      position:absolute; inset:42px 0 0 0;
      pointer-events:none;
      border-top:1px solid var(--frame);
    }
    /* Map container inside frame */
    #map{width:100%; height:calc(100vh - 84px);}

    /* Toolbar floating */
    .toolbar{
      position:absolute; top:70px; inset-inline-start:20px; z-index:900;
      display:flex; flex-direction:column; gap:10px;
    }
    .card{background:#fff; border:1px solid #e2e8f0; border-radius:16px; box-shadow:var(--shadow)}
    .tool-card{padding:10px}
    .tool-row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .select, .range{
      border:1px solid #e2e8f0; border-radius:12px; padding:8px 10px; font-weight:600; background:#fff; color:#0a1931
    }
    .legend{padding:10px 12px; font-size:13px}
    .legend .item{display:flex; align-items:center; gap:8px; margin:6px 0}
    .dot{width:12px; height:12px; border-radius:50%}
    .dot.red{background:var(--red)}
    .dot.amber{background:var(--amber)}
    .dot.green{background:var(--green)}

    /* Marker styles (Uber-like) */
    .pulse{
      width:14px; height:14px; border-radius:50%; position:relative; box-shadow:0 0 0 2px #fff, 0 4px 10px rgba(0,0,0,.25)
    }
    .pulse.red{background:var(--red)}
    .pulse.amber{background:var(--amber)}
    .pulse.green{background:var(--green)}
    .pulse.red::after, .pulse.amber::after{
      content:""; position:absolute; inset:0; border-radius:50%; box-shadow:0 0 0 0 currentColor; animation:pulse 1.8s infinite; opacity:.55
    }
    .pulse.red::after{color:var(--red)}
    .pulse.amber::after{color:var(--amber)}
    @keyframes pulse{0%{box-shadow:0 0 0 0 currentColor} 70%{box-shadow:0 0 0 14px rgba(0,0,0,0)} 100%{box-shadow:0 0 0 0 rgba(0,0,0,0)}}

    /* Modal (UPDATED smaller + responsive) */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:2000; padding:16px}
    .modal.open{display:flex}
    .modal-content{
      background:#fff; width:min(640px, 94vw);
      border-radius:16px; padding:14px; box-shadow:0 20px 60px rgba(0,0,0,.25)
    }
    .modal-header{
      display:flex; align-items:center; gap:8px; border-bottom:1px solid #e2e8f0;
      padding-bottom:8px; margin-bottom:10px
    }
    .modal-header .h-title{margin:0; font-weight:900; font-size:16px}
    .modal-actions{display:flex; gap:8px; margin-top:12px; justify-content:flex-end}
    .field{display:flex; flex-direction:column; gap:6px}
    textarea, select, input[type="file"]{border:1px solid #e2e8f0; border-radius:12px; padding:10px; font-family:inherit}
    .pill{display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; font-weight:800}
    .pill.red{background:#fee2e2; color:#991b1b}
    .pill.amber{background:#fef3c7; color:#92400e}
    .pill.green{background:#dcfce7; color:#065f46}

    /* Smart grid sizes for all devices */
    #modalBody{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px;
    }
    @media (max-width: 640px){
      #modalBody{grid-template-columns:1fr}
      .modal-content{padding:12px; width:95vw}
    }

    /* Toast */
    .toast{position:fixed; bottom:12px; inset-inline-start:12px; background:#0a1931; color:#fff; padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); z-index:3000; display:none}
    .toast.show{display:block}
  </style>
</head>
<body>

  <!-- Header -->
  <header class="app-header">
    <div class="brand">Smart HSR <span>Live&nbsp;Map</span></div>
    <div id="nearStats" class="counter" title="حول موقعي الآن">
      <div class="stat"><i data-lucide="map-pin" class="w-4 h-4"></i><span id="meDistLabel">—</span></div>
      <div class="stat"><i data-lucide="alert-triangle" class="w-4 h-4"></i>قريب: <b id="nearCount">0</b></div>
    </div>
    <div class="header-actions">
      <button id="locBtn" class="btn btn-primary"><i data-lucide="crosshair"></i>تحديد موقعي</button>
      <button id="centerBtn" class="btn btn-dark"><i data-lucide="navigation"></i>إعادة التمركز</button>
      <a href="index.html" class="btn btn-soft"><i data-lucide="layout-dashboard"></i>اللوحة التنفيذية</a>
    </div>
  </header>

  <!-- Map frame -->
  <div class="map-shell">
    <div class="map-frame">
      <div class="frame-topbar">
        <div class="title"><i data-lucide="map" class="w-4 h-4"></i> الخريطة الميدانية الذكية</div>
      </div>
      <!-- the map -->
      <div id="map"></div>
      <div class="frame-border"></div>

      <!-- Floating tools -->
      <div class="toolbar">
        <div class="tool-card card">
          <div class="tool-row" style="padding:8px 10px">
            <select id="statusFilter" class="select" title="فلترة حسب الحالة">
              <option value="ALL">كل الحالات</option>
              <option value="PENDING">جديد</option>
              <option value="IN_PROGRESS">قيد التنفيذ</option>
              <option value="COMPLETED">مغلق</option>
            </select>
            <label class="select" style="display:flex;align-items:center;gap:8px;">
              <i data-lucide="radar" class="w-4 h-4"></i>
              نصف القطر:
              <input id="radiusInput" type="range" min="500" max="5000" step="100" class="range" style="width:160px">
              <span id="radiusLabel" style="font-weight:800">2000 م</span>
            </label>
          </div>
        </div>

        <div class="legend card">
          <div style="font-weight:900; margin-bottom:6px">أسطورة الحالات</div>
          <div class="item"><span class="dot red"></span> جديد</div>
          <div class="item"><span class="dot amber"></span> قيد التنفيذ</div>
          <div class="item"><span class="dot green"></span> مغلق</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal (REPLACED, smaller & responsive) -->
  <div id="smartModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <i data-lucide="file-search" class="w-5 h-5"></i>
        <h3 id="modalTitle" class="h-title">تفاصيل الملاحظة</h3>
        <span id="modalChip" class="pill" style="margin-inline-start:auto"></span>
        <button id="closeBtn" class="btn btn-soft" style="padding:6px 10px;"><i data-lucide="x"></i>إغلاق</button>
      </div>

      <div id="modalBody">
        <div class="field">
          <label>العنوان</label>
          <div id="mTitle" class="card" style="padding:10px; font-weight:800;"></div>
        </div>
        <div class="field">
          <label>المسافة من موقعي</label>
          <div id="mDistance" class="card" style="padding:10px; font-weight:800;"></div>
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>الوصف</label>
          <div id="mDetails" class="card" style="padding:12px; line-height:1.8"></div>
        </div>
        <div class="field">
          <label>الحالة</label>
          <select id="mStatus" class="select">
            <option value="PENDING">جديد</option>
            <option value="IN_PROGRESS">قيد التنفيذ</option>
            <option value="COMPLETED">مغلق</option>
          </select>
        </div>
        <div class="field">
          <label>صورة بعد الإصلاح (اختياري/إلزامي عند الإغلاق)</label>
          <input id="afterInput" type="file" accept="image/*">
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>المذكرة الختامية</label>
          <textarea id="mNote" rows="3" placeholder="اكتب المذكرة هنا..."></textarea>
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>المرفق الحالي</label>
          <div id="mMedia" class="card" style="padding:8px"></div>
        </div>
      </div>

      <div class="modal-actions">
        <button id="saveBtn" class="btn btn-primary"><i data-lucide="save"></i>حفظ التحديث</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">تم الحفظ بنجاح</div>

  <!-- Firebase + App -->
  <script type="module">
    // ============ Firebase ============
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, onSnapshot, doc, updateDoc, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBfClVxFIXgUXL4olEv5SepUDtzk0dq3lo",
      authDomain: "gen-lang-client-0349944917.firebaseapp.com",
      projectId: "gen-lang-client-0349944917",
      storageBucket: "gen-lang-client-0349944917.firebasestorage.app",
      messagingSenderId: "883065484771",
      appId: "1:883065484771:web:c907bb5a51f68caad75cd6",
      measurementId: "G-V8WG5M8V5B"
    };

    let app, db, FIREBASE_READY=false;
    try { app = initializeApp(firebaseConfig); db = getFirestore(app); FIREBASE_READY=true; }
    catch(e){ console.warn("Firebase init failed, running local-only.", e); }

    // ============ Map Init ============
    const map = L.map('map', { zoomControl:false, attributionControl:true });
    // نبدأ على الرياض افتراضيًا
    map.setView([24.7136, 46.6753], 10);
    L.control.zoom({ position:'topright' }).addTo(map);

    // طبقة أساسية
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom:19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // أيقونات ديناميكية
    const markerIcon = (status)=> L.divIcon({
      html:`<div class="pulse ${status==='PENDING'?'red':status==='IN_PROGRESS'?'amber':'green'}"></div>`,
      className:'', iconSize:[16,16], iconAnchor:[8,8]
    });

    // حالتي على الخريطة + الإطار
    let meMarker=null, meCircle=null, lastMe=[24.7136,46.6753];
    const radiusInput=document.getElementById('radiusInput');
    radiusInput.value=2000;

    function drawMe(){
      const r=parseInt(radiusInput.value||2000,10);
      if (meMarker) meMarker.remove();
      if (meCircle) meCircle.remove();
      meMarker = L.marker(lastMe, { icon:L.divIcon({html:'<div class="pulse amber" style="width:16px;height:16px"></div>', className:'', iconSize:[16,16], iconAnchor:[8,8]})}).addTo(map);
      meCircle = L.circle(lastMe, { radius:r, color:'#18A5A2', fillColor:'#18A5A2', fillOpacity:0.08, weight:2 }).addTo(map);
    }

    function haversine(a,b){
      const toRad = d=> d*Math.PI/180;
      const [lat1,lon1]=a, [lat2,lon2]=b;
      const R=6371000; // meters
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2);
      const c=2*Math.asin(Math.sqrt(s1*s1 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*s2*s2));
      return R*c;
    }

    // ============ Observations Layer ============
    const markers = new Map(); // docId -> marker
    let observations = [];     // raw list

    const statusFilter = document.getElementById('statusFilter');
    const nearCountEl  = document.getElementById('nearCount');
    const meDistLabel  = document.getElementById('meDistLabel');
    const radiusLabel  = document.getElementById('radiusLabel');

    function fmtMeters(m){ return m<1000 ? `${Math.round(m)} م` : `${(m/1000).toFixed(1)} كم`; }

    function paint(){
      drawMe();
      const filter = statusFilter.value;
      const r = parseInt(radiusInput.value,10);
      radiusLabel.textContent = `${r} م`;

      let near=0;
      const presentIds=new Set();
      for (const o of observations){
        if (!o.location) continue;
        const [lat, lon] = o.location.split(',').map(n=>parseFloat(n.trim()));
        if (Number.isNaN(lat) || Number.isNaN(lon)) continue;
        if (filter!=='ALL' && o.status!==filter) continue;

        const dist = haversine(lastMe, [lat,lon]);
        const inRadius = dist<=r;
        if (inRadius) near++;

        let m = markers.get(o.docId);
        if (!m){
          m = L.marker([lat,lon], { icon: markerIcon(o.status) }).addTo(map);
          m.bindTooltip(o.title || '', { direction:'top', offset:[0,-10] });
          m.on('click', ()=> openModalFor(o, dist));
          markers.set(o.docId, m);
        } else {
          m.setIcon(markerIcon(o.status));
          m.setLatLng([lat,lon]);
        }
        presentIds.add(o.docId);
      }
      for (const [id, m] of markers){
        if (!presentIds.has(id)){ m.remove(); markers.delete(id); }
      }
      nearCountEl.textContent = near.toString();
      meDistLabel.textContent = `نطاقي: ${fmtMeters(r)}`;
    }

    // ============ Firestore live ============
    async function startLive(){
      if (!FIREBASE_READY){
        // Demo fallback
        observations = [
          {docId:'local-1', id:1, title:'هبوط بسيط بالممر الجانبي', status:'PENDING', type:'MAINTENANCE', date:'2025-10-01', details:'ملاحظة تجربة.', location:'24.774265,46.738586', imagePath:'https://picsum.photos/600/400?1'},
          {docId:'local-2', id:2, title:'تشققات عرضية', status:'IN_PROGRESS', type:'QUALITY', date:'2025-10-03', details:'جاري الإصلاح.', location:'24.633333,46.716667', imagePath:'https://picsum.photos/600/400?2'},
          {docId:'local-3', id:3, title:'لوحة إرشادية تالفة', status:'COMPLETED', type:'QUALITY', date:'2025-10-05', details:'تم الاستبدال.', location:'24.7136,46.6753', imagePath:'https://picsum.photos/600/400?3', afterImagePath:'https://picsum.photos/600/400?4', resolutionNote:'حسب المواصفات'}
        ];
        paint();
        return;
      }
      const q = query(collection(db,'observations'), orderBy('createdAt','desc'));
      onSnapshot(q, (snap)=>{
        const arr=[];
        snap.forEach(d=>{
          const data=d.data();
          arr.push({
            docId:d.id,
            id: data.displayId || 0,
            title:data.title||'—',
            status:data.status||'PENDING',
            type:data.type||'MAINTENANCE',
            date:data.date||'',
            details:data.details||'',
            location:data.location||'',
            imagePath:data.imagePath||null,
            afterImagePath:data.afterImagePath||null,
            resolutionNote:data.resolutionNote||''
          });
        });
        observations = arr;
        paint();
      });
    }

    // ============ Geolocation ============
    const locBtn=document.getElementById('locBtn');
    const centerBtn=document.getElementById('centerBtn');

    let watchId=null;
    function startWatch(){
      if (!navigator.geolocation){ alert('المتصفح لا يدعم تحديد الموقع.'); return; }
      if (watchId!==null) return;
      watchId = navigator.geolocation.watchPosition(pos=>{
        lastMe=[pos.coords.latitude, pos.coords.longitude];
        paint();
      }, err=>{
        console.warn(err);
        alert('تعذر تحديد الموقع. يرجى السماح بالصلاحيات.');
      }, { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
    }

    locBtn.addEventListener('click', ()=>{
      startWatch();
      map.setView(lastMe, 14, { animate:true });
    });
    centerBtn.addEventListener('click', ()=>{
      map.setView(lastMe, map.getZoom()<14?14:map.getZoom(), { animate:true });
    });

    statusFilter.addEventListener('change', paint);
    radiusInput.addEventListener('input', paint);

    // ============ Modal Logic ============
    const modal     = document.getElementById('smartModal');
    const closeBtn  = document.getElementById('closeBtn');
    const saveBtn   = document.getElementById('saveBtn');
    const mStatus   = document.getElementById('mStatus');
    const mTitleEl  = document.getElementById('mTitle');
    const mDetails  = document.getElementById('mDetails');
    const mMedia    = document.getElementById('mMedia');
    const mNote     = document.getElementById('mNote');
    const mDistance = document.getElementById('mDistance');
    const modalChip = document.getElementById('modalChip');
    const afterInput= document.getElementById('afterInput');

    let currentDocId=null, currentAfterData=null, currentObj=null;

    afterInput.addEventListener('change', async (e)=>{
      const f=e.target.files?.[0];
      if (!f) { currentAfterData=null; return; }
      if (!f.type.startsWith('image/')) { alert('يجب اختيار صورة.'); e.target.value=''; return; }
      currentAfterData = await toBase64(f);
    });

    function setChip(status){
      modalChip.className='pill '+(status==='PENDING'?'red':status==='IN_PROGRESS'?'amber':'green');
      modalChip.innerHTML = status==='PENDING'?'جديد':status==='IN_PROGRESS'?'قيد التنفيذ':'مغلق';
    }

    function openModalFor(o, dist){
      currentObj = o; currentDocId=o.docId; currentAfterData=null;
      document.getElementById('modalTitle').textContent = `ملاحظة #${o.id||'—'}`;
      mTitleEl.textContent = o.title||'—';
      mDetails.innerHTML = (o.details||'—').replace(/\n/g,'<br>');
      mStatus.value = o.status||'PENDING';
      setChip(o.status||'PENDING');
      mNote.value = o.resolutionNote||'';
      mDistance.textContent = fmtMeters(dist||0);

      mMedia.innerHTML = '';
      if (o.afterImagePath){
        mMedia.innerHTML = `
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <img src="${o.imagePath||''}" alt="قبل" style="width:100%;border-radius:12px">
            <img src="${o.afterImagePath||''}" alt="بعد" style="width:100%;border-radius:12px">
          </div>`;
      } else if (o.imagePath){
        mMedia.innerHTML = `<img src="${o.imagePath}" alt="مرفق" style="width:100%;border-radius:12px">`;
      } else {
        mMedia.innerHTML = `<div class="card" style="padding:10px;text-align:center">لا يوجد مرفق</div>`;
      }

      modal.classList.add('open');
    }

    closeBtn.addEventListener('click', ()=> modal.classList.remove('open'));
    modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.classList.remove('open'); });

    saveBtn.addEventListener('click', async ()=>{
      if (!currentDocId){ modal.classList.remove('open'); return; }
      const newStatus = mStatus.value;
      if (newStatus==='COMPLETED' && !currentAfterData && !currentObj?.afterImagePath){
        const ok = confirm('إغلاق يتطلب صورة "بعد". هل تريد المتابعة بدون صورة؟');
        if (!ok) return;
      }
      const payload = {
        status: newStatus,
        resolutionNote: mNote.value || `تم التحديث بتاريخ ${new Date().toLocaleString('ar-SA')}`
      };
      if (currentAfterData) payload.afterImagePath = currentAfterData;

      try {
        if (FIREBASE_READY){
          await updateDoc(doc(db,'observations', currentDocId), payload);
        } else {
          // Demo update (محلي)
          const idx = observations.findIndex(x=>x.docId===currentDocId);
          if (idx>-1){
            observations[idx] = { ...observations[idx], ...payload };
          }
        }
        // حدث العناصر على الخريطة مباشرة لضمان الاستجابة الفورية
        if (markers.has(currentDocId)){
          const mk = markers.get(currentDocId);
          mk.setIcon(markerIcon(newStatus));
        }
        // حدث الكائن الحالي
        if (currentObj){
          currentObj.status = newStatus;
          if (payload.afterImagePath) currentObj.afterImagePath = payload.afterImagePath;
          currentObj.resolutionNote = payload.resolutionNote;
        }
        setChip(newStatus);
        showToast('تم الحفظ بنجاح');
        modal.classList.remove('open');
        paint();
      } catch (e){
        console.error(e);
        showToast('تعذر الحفظ، تحقق من الاتصال');
      }
    });

    // ============ Helpers ============
    function showToast(text){
      const t=document.getElementById('toast'); t.textContent=text; t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 2000);
    }
    function toBase64(file){
      return new Promise((res,rej)=>{
        const reader = new FileReader();
        reader.onload = e=> res(e.target.result);
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });
    }

    // ============ Start ============
    startLive();
    drawMe();
    lucide.createIcons();

    // تحفظ موضع الخريطة داخل الإطار عند تغيير الحجم
    window.addEventListener('resize', ()=> { map.invalidateSize(); });
  </script>
</body>
</html>
